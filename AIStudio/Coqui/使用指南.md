# Coqui TTS 服务使用指南

## 🎯 快速开始

### 1. 部署服务

```bash
# 进入服务目录
cd /home/n8n/AIStudio/Coqui

# 运行自动化部署脚本
./deploy.sh
```

### 2. 验证服务

```bash
# 使用快速启动脚本检查状态
./quick_start.sh status

# 运行快速测试
./quick_start.sh test
```

### 3. 首次音频生成

```bash
# 最简单的音频生成
curl -X POST "http://localhost:8001/generate" \
     -H "Content-Type: application/json" \
     -d '{
       "text": "欢迎使用Coqui TTS服务",
       "output_filename": "welcome.mp3"
     }'
```

## 📖 详细使用说明

### 基础概念

**Coqui TTS服务**是一个持久化的GPU加速音频生成服务，具有以下特点：

- ✅ **模型常驻GPU**：首次启动后模型保持在GPU内存中
- ✅ **快速响应**：后续请求只需几秒钟
- ✅ **7x24运行**：Systemd管理，自动重启
- ✅ **REST API**：标准HTTP接口，易于集成

### API接口详解

#### 1. 生成音频 (`/generate`)

**请求参数**:
```json
{
    "text": "必需 - 要转换的文本内容",
    "speaker_wav": "可选 - 说话人音频文件路径",
    "output_filename": "可选 - 输出文件名"
}
```

**响应格式**:
```json
{
    "success": true/false,
    "task_id": "任务唯一标识",
    "output_path": "输出文件完整路径",
    "processing_time": "处理时间（秒）",
    "error": "错误信息（失败时）"
}
```

**使用示例**:

1. **基础用法**：
```bash
curl -X POST "http://localhost:8001/generate" \
     -H "Content-Type: application/json" \
     -d '{"text": "这是一个测试", "output_filename": "basic_test.mp3"}'
```

2. **使用自定义说话人**：
```bash
curl -X POST "http://localhost:8001/generate" \
     -H "Content-Type: application/json" \
     -d '{
       "text": "使用自定义语音",
       "speaker_wav": "/home/n8n/AIStudio/default_speaker.wav",
       "output_filename": "custom_voice.mp3"
     }'
```

3. **Python调用**：
```python
import requests
import json

def generate_audio(text, speaker_wav=None, output_filename=None):
    url = "http://localhost:8001/generate"
    payload = {
        "text": text,
        "speaker_wav": speaker_wav,
        "output_filename": output_filename
    }

    response = requests.post(url, json=payload)
    return response.json()

# 使用示例
result = generate_audio(
    text="Python客户端测试",
    output_filename="python_demo.mp3"
)

if result["success"]:
    print(f"音频生成成功: {result['output_path']}")
    print(f"处理时间: {result['processing_time']:.2f}秒")
else:
    print(f"生成失败: {result['error']}")
```

#### 2. 健康检查 (`/health`)

**功能**：检查服务运行状态和模型加载情况

```bash
curl http://localhost:8001/health
```

**响应示例**：
```json
{
    "status": "healthy",
    "model_loaded": true,
    "gpu_available": true,
    "gpu_memory_used": 2.1
}
```

#### 3. 服务统计 (`/stats`)

**功能**：获取详细的GPU和服务统计信息

```bash
curl http://localhost:8001/stats
```

**响应示例**：
```json
{
    "gpu_name": "NVIDIA GeForce RTX 3090",
    "total_memory_gb": 24.0,
    "allocated_memory_gb": 3.2,
    "available_memory_gb": 20.8,
    "model_loaded": true
}
```

## 🔧 服务管理

### 日常管理命令

```bash
# 快速检查状态
./quick_start.sh status

# 快速测试服务
./quick_start.sh test

# 查看管理命令
./quick_start.sh commands

# 查看使用示例
./quick_start.sh examples
```

### Systemd服务管理

```bash
# 启动服务
sudo systemctl start tts-service

# 停止服务
sudo systemctl stop tts-service

# 重启服务
sudo systemctl restart tts-service

# 查看服务状态
sudo systemctl status tts-service

# 开机自启
sudo systemctl enable tts-service

# 查看实时日志
sudo journalctl -u tts-service -f
```

### 日志查看

```bash
# 查看最近50条日志
sudo journalctl -u tts-service -n 50

# 只看错误日志
sudo journalctl -u tts-service -p err

# 按时间范围查看
sudo journalctl -u tts-service --since "1 hour ago"

# 查看详细的access日志
sudo tail -f /var/log/tts_service/access.log
```

## 📊 性能监控

### GPU监控

```bash
# 实时GPU状态
watch -n 2 nvidia-smi

# 查看GPU使用趋势
nvidia-smi dmon -s u -d 1

# 查看服务内存使用
curl -s http://localhost:8001/stats | python3 -m json.tool
```

### 性能基准测试

```bash
# 运行完整性能测试
python test_client.py

# 自定义批量测试
python3 -c "
import requests
import time

texts = [
    '测试文本1：GPU加速效果显著',
    '测试文本2：响应速度很快',
    '测试文本3：适合生产环境'
]

total_time = 0
success_count = 0

for i, text in enumerate(texts, 1):
    start_time = time.time()

    response = requests.post(
        'http://localhost:8001/generate',
        json={'text': text, 'output_filename': f'bench_test_{i}.mp3'}
    )

    processing_time = time.time() - start_time
    total_time += processing_time

    if response.json().get('success'):
        success_count += 1
        print(f'请求 {i}: {processing_time:.2f}秒')
    else:
        print(f'请求 {i}: 失败')

print(f'\\n成功率: {success_count}/{len(texts)}')
print(f'平均时间: {total_time/len(texts):.2f}秒')
"
```

## 🚀 高级用法

### 1. 批量音频生成

```python
# batch_generate.py
import requests
import json
import time

def batch_generate(texts, output_prefix="batch"):
    """批量生成音频"""
    results = []

    for i, text in enumerate(texts, 1):
        print(f"正在处理第 {i}/{len(texts)} 个音频...")

        response = requests.post(
            "http://localhost:8001/generate",
            json={
                "text": text,
                "output_filename": f"{output_prefix}_{i:03d}.mp3"
            }
        )

        if response.json().get("success"):
            results.append(response.json())
        else:
            print(f"失败: {text[:30]}...")

    return results

# 使用示例
texts = [
    "这是第一个测试音频",
    "这是第二个测试音频",
    "这是第三个测试音频"
]

results = batch_generate(texts, "demo")
print(f"成功生成 {len(results)} 个音频文件")
```

### 2. 自定义说话人训练

虽然服务使用的是预训练XTTS模型，但你可以：

1. **提供高质量的说话人音频**：
```bash
# 确保说话人音频文件存在
ls -la /home/n8n/AIStudio/default_speaker.wav

# 使用说话人音频
curl -X POST "http://localhost:8001/generate" \
     -H "Content-Type: application/json" \
     -d '{
       "text": "使用自定义语音",
       "speaker_wav": "/home/n8n/AIStudio/default_speaker.wav",
       "output_filename": "custom_demo.mp3"
     }'
```

2. **说话人音频要求**：
- 格式：WAV
- 采样率：22050Hz 或更高
- 长度：建议2-30秒
- 质量：清晰无噪音

### 3. 集成到n8n工作流

在n8n中添加HTTP Request节点：

```json
{
  "method": "POST",
  "url": "http://localhost:8001/generate",
  "headers": {
    "Content-Type": "application/json"
  },
  "body": {
    "text": "={{ $json.text }}",
    "output_filename": "={{ $json.filename }}"
  }
}
```

### 4. 监控和告警

```python
# monitor.py
import requests
import time
import smtplib

def check_service_health():
    """检查服务健康状态"""
    try:
        response = requests.get("http://localhost:8001/health", timeout=5)
        if response.status_code == 200:
            data = response.json()
            return data.get("status") == "healthy"
        return False
    except:
        return False

def monitor_service(interval=60):
    """持续监控服务状态"""
    while True:
        if not check_service_health():
            print("⚠️ 服务状态异常!")
            # 发送告警邮件或通知
            send_alert("Coqui TTS服务状态异常")

        time.sleep(interval)

def send_alert(message):
    """发送告警通知"""
    # 这里实现你的告警逻辑
    print(f"告警: {message}")
```

## 🔍 故障排除

### 常见问题

1. **服务启动失败**
```bash
# 查看详细错误
sudo journalctl -u tts-service -n 50

# 常见原因：
# - GPU不可用
# - 内存不足
# - 依赖缺失
```

2. **模型加载失败**
```bash
# 检查网络连接
ping huggingface.co

# 检查磁盘空间
df -h ~/.local/share/tts/

# 手动测试TTS
python3 -c "
from TTS.api import TTS
tts = TTS(model_name='tts_models/multilingual/multi-dataset/xtts_v2')
print('模型加载成功')
"
```

3. **音频生成失败**
```bash
# 检查输出目录权限
ls -la /home/n8n/AIStudio/jobs/audio/

# 检查说话人文件
ls -la /home/n8n/AIStudio/default_speaker.wav

# 查看GPU内存使用
nvidia-smi
```

4. **性能问题**
```bash
# 检查GPU使用率
nvidia-smi dmon -s u -d 1

# 检查服务日志中的性能指标
sudo journalctl -u tts-service | grep "processing_time"

# 重启服务清理内存
sudo systemctl restart tts-service
```

### 性能优化建议

1. **批量处理**：尽量使用批量请求而非单个请求
2. **文本分段**：长文本会自动分段，但可以手动控制分段长度
3. **GPU监控**：定期检查GPU使用率，避免内存泄漏
4. **日志管理**：定期清理日志文件避免磁盘空间不足

## 📁 文件和目录

### 重要路径

```
服务文件：/home/n8n/AIStudio/Coqui/
音频输出：/home/n8n/AIStudio/jobs/audio/
日志文件：/var/log/tts_service/
模型缓存：~/.local/share/tts/
Systemd配置：/etc/systemd/system/tts-service.service
```

### 备份建议

```bash
# 备份服务配置
cp -r /home/n8n/AIStudio/Coqui /backup/coqui_service_backup/

# 备份音频文件
tar -czf audio_backup_$(date +%Y%m%d).tar.gz /home/n8n/AIStudio/jobs/audio/

# 导出服务配置
sudo systemctl cat tts-service.service > tts-service_backup.conf
```

---

## 🎉 结语

Coqui TTS服务现在已经准备就绪！通过这个服务，你可以：

- **快速生成**：秒级响应的高质量中文语音
- **稳定运行**：7x24小时不间断服务
- **轻松集成**：标准的REST API，支持各种应用场景

如需技术支持或遇到问题，请查看日志文件或使用提供的诊断工具。

**享受高质量的TTS服务！** 🎵